sudo apt update
sudo apt upgrade -y

sudo apt install curl

#Conseguir el fichero agent.py

#Instalar Python 2.7
	curl https://bootstrap.pypa.io/pip/2.7/get-pip.py -o get-pip.py
	sudo apt install python2
	sudo python2 get-pip.py
	pip2 install pymongo

#Configuramos el agente para que se inicie automaticamente
	whereis python2
	sudo crontab -e
	@reboot /usr/bin/python2.7 /path/to/agent.py

#Instalamos dependencias
	sudo apt-get install systemtap gcc patch linux-headers-$(uname -r)

#Instalamos símbolos de debuggeo
sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys C8CAB6595FDFF622

codename=$(lsb_release -cs)
sudo nano /etc/apt/sources.list.d/ddebs.list

  deb http://ddebs.ubuntu.com/ ${codename}          main restricted universe multiverse
  #deb http://ddebs.ubuntu.com/ ${codename}-security main restricted universe multiverse
  deb http://ddebs.ubuntu.com/ ${codename}-updates  main restricted universe multiverse
  deb http://ddebs.ubuntu.com/ ${codename}-proposed main restricted universe multiverse

sudo apt-get update
sudo apt-get install linux-image-$(uname -r)-dbgsym

#
	wget https://raw.githubusercontent.com/cuckoosandbox/cuckoo/master/stuff/systemtap/expand_execve_envp.patch
	wget https://raw.githubusercontent.com/cuckoosandbox/cuckoo/master/stuff/systemtap/escape_delimiters.patch
	sudo patch /usr/share/systemtap/tapset/linux/sysc_execve.stp < expand_execve_envp.patch
	sudo patch /usr/share/systemtap/tapset/uconversions.stp < escape_delimiters.patch

#Compilamos la extensión del kernel
	wget https://raw.githubusercontent.com/cuckoosandbox/cuckoo/master/stuff/systemtap/strace.stp
	
	#https://github.com/cuckoosandbox/cuckoo/issues/2684
	sudo apt-get remove systemtap
	sudo apt-get install gcc g++ elfutils libdw-dev elfutils build-essential
	#Descargamos la más reciente https://sourceware.org/systemtap/wiki/SystemTapReleases (4.7 yo)
	tar xf systemtap-x.x.tar.gz
	cd systemtap-*
	./configure
	sudo make
	sudo make install
	
	sudo stap -p4 -r $(uname -r) strace.stp -m stap_ -v

#Testeamos la extensión
	sudo staprun -v ./stap_.ko
	##Output: staprun:insert_module:x Module stap_ inserted from file path_to_stap_.ko

#Colocamos correctamente la extensión
	sudo mkdir /root/.cuckoo
	sudo mv stap_.ko /root/.cuckoo/

#Desactivamos el firewall de la MV
	sudo ufw disable

#Desactivamos NTP
	sudo timedatectl set-ntp off

#Desactivación de software preinstalado
	sudo apt-get purge update-notifier update-manager update-manager-core ubuntu-release-upgrader-core
	sudo apt-get purge whoopsie ntpdate cups-daemon avahi-autoipd avahi-daemon avahi-utils
	sudo apt-get purge account-plugin-salut libnss-mdns telepathy-salut

	sudo apt autoremove
	
#Modificar en la configuración de VirtualBox para eliminar el adaptador de NAt y poner un adaptador solo anfitrion con vboxnet0 previamente configurado.

#Configurar los parámetros de red
	#IP = 192.168.56.101
	#Subnet = 255.255.255.0
	#Gateway = 192.168.56.1
	#DNS = 8.8.8.8 / 8.8.4.4

#Ejecutar el escript agent.py

#Finalmente crear la snapshot Final, estando en ejecución la maquina virtual.

